version: '3.8'

services:
  stock-anomaly-detector:
    build:
      context: .
      dockerfile: Dockerfile
    image: stock-anomaly-detector:latest
    container_name: stock-anomaly-detector
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/stocks/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_APPLICATION_NAME=stock-anomaly-detector
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS}
      - SPRING_KAFKA_PROPERTIES_SECURITY_PROTOCOL=SASL_SSL
      - SPRING_KAFKA_PROPERTIES_SASL_MECHANISM=PLAIN
      - SPRING_KAFKA_PROPERTIES_SASL_JAAS_CONFIG=${KAFKA_SASL_JAAS_CONFIG}
      - SPRING_KAFKA_STREAMS_APPLICATION_ID=stock-processing-streams-v1
      - SPRING_KAFKA_STREAMS_REPLICATION_FACTOR=3
      - SPRING_KAFKA_STREAMS_PROPERTIES_DEFAULT_KEY_SERDE=org.apache.kafka.common.serialization.Serdes$$StringSerde
      - SPRING_KAFKA_STREAMS_PROPERTIES_DEFAULT_VALUE_SERDE=org.springframework.kafka.support.serializer.JsonSerde
      - SPRING_KAFKA_PRODUCER_KEY_SERIALIZER=org.apache.kafka.common.serialization.StringSerializer
      - SPRING_KAFKA_PRODUCER_VALUE_SERIALIZER=org.springframework.kafka.support.serializer.JsonSerializer
      - SPRING_KAFKA_CONSUMER_GROUP_ID=stock-consumers
      - SPRING_KAFKA_CONSUMER_AUTO_OFFSET_RESET=earliest
      - SPRING_KAFKA_CONSUMER_KEY_DESERIALIZER=org.apache.kafka.common.serialization.StringDeserializer
      - SPRING_KAFKA_CONSUMER_VALUE_DESERIALIZER=org.springframework.kafka.support.serializer.ErrorHandlingDeserializer
      - SPRING_KAFKA_CONSUMER_PROPERTIES_SPRING_DESERIALIZER_VALUE_DELEGATE_CLASS=org.springframework.kafka.support.serializer.JsonDeserializer
      - SPRING_KAFKA_CONSUMER_PROPERTIES_SPRING_JSON_TRUSTED_PACKAGES=*
      - APP_TOPIC_INPUT_PRICES=${TOPIC_INPUT_PRICES:-stock-prices-input}
      - APP_TOPIC_OUTPUT_TICKER=${TOPIC_OUTPUT_TICKER:-stock-ticker-output}
      - APP_TOPIC_OUTPUT_ANOMALY=${TOPIC_OUTPUT_ANOMALY:-stock-anomaly-alerts}
      - JAVA_OPTS=-Xms512m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
